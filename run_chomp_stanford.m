close all;
clear all;

cd(fileparts(mfilename('fullpath')));

opt = struct(...
    'input_folder', '/mnt/stanford/home/gbohner/derived2/input/', ...
    'output_folder', '/mnt/stanford/home/gbohner/derived2/output/', ...
    'precomputed_folder', '/mnt/stanford/home/gbohner/derived2/precomputed/', ...
    'data_type', 'frames', ...
    'init_model','filled', ...
    'niter', 4, ...
    'm', 17, ...
    'mom', 2, ...
    'fig',1, ...
    'spatial_scale',1,...
    'time_scale',1,...
    'mask', 0, ...
    'smooth_filter_mean',2, ...
    'smooth_filter_var',2, ...
    'cells_per_image', 50, ...
    'KS', 4 ...
  );

 %opt.data_path = '/mnt/stanford/neurotank/Watkins/2016-02-19/2P/CenterOutReach/site002/Tseries_20160219_Watkins_CenterOutReach_time20160219.133302.428-001/Tseries_20160219_Watkins_CenterOutReach_time20160219.133302.428-001_Cycle00001_Ch2_000001.ome.tif';
 %opt.data_path = '/mnt/stanford/neurotank/Watkins/2016-02-19/2P/CenterOutReach/site002/Tseries_20160219_Watkins_CenterOutReach_time20160219.133302.428-001/Tseries_20160219_Watkins_CenterOutReach_time20160219.133302.428-001_Cycle00001_Ch2_000001.ome.tif';
 
% For local run and local data 
opt.data_path = '~/stanford/Tseries_20160219_Watkins_CenterOutReach_time20160219.133302.428-001/Tseries_20160219_Watkins_CenterOutReach_time20160219.133302.428-001_Cycle00001_Ch2_000001.ome.tif';
opt.input_folder = '~/stanford/input/';
opt.output_folder = '~/stanford/output/';
opt.precomputed_folder = '~/stanford/precomputed/';

% Varius param settings
%opt.spatial_scale = 0.2;
%opt.m = 5;
%opt.spatial_push = @(grid_dist)logsig(0.5*grid_dist-floor((opt.m+3)/2-1)); %Should be change when opt.m is changed (%TODO automatically, perhaps with linking to the opt.m variable, symbolic matlab)
%opt.mom = 4;
opt.data_type = 'frames_virtual';
 
[~, opt.file_prefix] = fileparts(opt.data_path);

[opt, ROI_mask, ROIs] = chomp(opt);

get_cell_timescales;

% load('../data_for_gergo/S1-T52844_masks.mat', 'donut')

% figure(2); imshowpair(ROI_mask, donut>0);